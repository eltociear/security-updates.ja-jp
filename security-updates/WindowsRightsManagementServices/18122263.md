---
TOCTitle: 構成データベースの移行
Title: 構成データベースの移行
ms:assetid: '980e3e94-7d28-40dd-ad01-d34eb3c8d8e6'
ms:contentKeyID: 18122263
ms:mtpsurl: 'https://technet.microsoft.com/ja-jp/library/Cc747607(v=WS.10)'
---

構成データベースの移行
======================

データベース サーバーの使用停止が必要になる状況があります。RMS データベース サーバー ハードウェアのアップグレードの場合などです。データベース サーバーを使用停止にする前に、構成データベースを別のデータベース サーバーに移動する必要があります。構成データベースに格納されているキー ペアなど、構成データベースのデータを保護するため、移行の計画と実施には十分な注意が必要です。

RMS データベース サーバーの CNAME エイリアスを作成し、このエイリアスを使用するように RMS を構成することをお勧めします。これにより、サーバーの名前が変わっても RMS 構成データベースのデータベース名を手動で変更する必要がなくなります。CNAME エイリアスを使用する場合、エイリアス レコードを更新するだけで済みます。

構成データベースの移行を開始する前に、次の情報を確認します。

-   このデータベースを使用する RMS クラスタ内のサーバーを提供するために当初使用していたアカウント名とパスワード。
-   RMS 秘密キーの格納にソフトウェアベースの暗号化サービス プロバイダ (CSP) を使用している場合は、提供時に当初指定した RMS 秘密キー パスワードになります。RMS 秘密キー パスワードの格納にハードウェア セキュリティ モジュール (HSM) を使用している場合、この手順は不要です。

> [!Note]  
> RMS は元の構成データベースから設定を保持するため、構成データベースの移行に、新しいサーバー ライセンサ証明書または新しいサーバー秘密キーは必要ありません。 

データベース サーバーで作業を開始する前に、RMS データベースをバックアップする必要があります。少なくともサーバー ライセンサ証明書のエクスポートは必ず実行してください。サーバー ライセンサ証明書のエクスポートの詳細については、[サーバー ライセンサ証明書をファイルにエクスポートするには](https://technet.microsoft.com/d683a629-71b3-4b11-932b-4ab0317334af)を参照してください。データベース移行時にエラーが発生した場合、サーバー ライセンサ証明書を新しい RMS インストールにインポートして、以前のインストールで権利保護されたコンテンツを使用することができます。

構成データベースを移行するには、次の手順に従います。

-   RMS 構成データベースを更新して、新しいデータベース サーバー名を反映させます。
-   RMS クラスタの各サーバーで、新しいデータベース サーバー名を使用するように web.config ファイルとレジストリを更新します。

> [!Important]  
> このトピックでは、RMS データベースが RMS データベースをホストする新しいデータベース サーバーにコピーされていることを前提にしています。 

新しいデータベース サーバー名を使用するように RMS 構成データベースを更新します。
--------------------------------------------------------------------------------

RMS データベースをホストするデータベース サーバーの名前は、RMS 構成データベースに格納されています。データベース ファイルを新しいデータベース サーバーに移行した後、RMS 構成データベースを更新する必要があります。この作業を行うには、RMS 管理ツールキットの RMS Config Editor ツールを使用するか、SQL Management Studio を使用します。

RMS Config Editor を使用して RMS データベース サーバー名を更新するには、次の手順に従います。

**RMS Config Editor を使用して RMS 構成データベースを更新するには**
1.  クラスタ内の RMS サーバーにシステム管理者データベース ロールのメンバとしてログオンします。

2.  Microsoft ダウンロード センター ([http://go.microsoft.com/fwlink/?LinkId=98961](http://go.microsoft.com/fwlink/?linkid=98961)) から RMS 管理ツールキットをインストールします。

3.  %SystemDrive%:\\Program Files\\RMS SP2 Administration Toolkit\\RMSConfigEditor に移動し、RMSCONFIGEDITOR.EXE をダブルクリックします。

4.  \[Server\] ボックスに RMS 構成データベースをホストする新しいサーバーの数を入力し、\[Go\] をクリックします。

5.  \[Database\] ボックスで、\[DRMS\_Config\_*&lt;RMS クラスタ名&gt;***\_***&lt;ポート&gt;*\] をクリックします。*&lt;RMS クラスタ名&gt;* は RMS クラスタの名前、*&lt;ポート&gt;* は RMS 通信に使用する TCP ポートです。次に \[Go\] をクリックします。

6.  \[DRMS\_ClusterPolicies\] をクリックします。

7.  結果ウィンドウで、\[LoggingDatabaseServer\] 行の \[PolicyData\] 列の値を新しい RMS データベース サーバー名に変更します。

8.  \[Persist\] をクリックします。

9.  \[CertificationUserKeyStorageConnectionString\] 行の \[PolicyData\] 列の値を新しいデータベース サーバーに合わせて変更します。値は、「data source=*&lt;新しいデータベース サーバー名&gt;*;integrated」にする必要があります。*&lt;新しいデータベース サーバー名&gt;* は、新しいデータベース サーバーの名前です。

10. \[Persist\] をクリックします。

11. \[DirectoryServicesCacheDatabase\] 行の \[PolicyData\] 列の値に対しても手順 9 ～ 10 を繰り返します。

12. 左ペインで \[DRMS\_PluginProperties\] をクリックします。

13. プロパティ ID 101 の \[PERSISTENT\_STORAGE\] で、\[PropertyValue\] 列を新しいデータベース サーバーに合わせて変更します。値は、「data source=*&lt;新しいデータベース サーバー名&gt;*;integrated」にする必要があります。*&lt;新しいデータベース サーバー名&gt;* は、新しいデータベース サーバーの名前です。

14. \[Persist\] をクリックします。

15. RMS Config Editor を閉じます。

SQL Server Management Studio を使用して RMS 構成データベースを更新するには、次の手順に従います。

**SQL Server Management Studio を使用して RMS 構成データベースを更新するには**
1.  ローカル管理者またはローカル Administrators グループのメンバの別のユーザー アカウントを使用して、RMS 構成データベースにログオンします。

2.  \[スタート\] ボタンをクリックし、\[すべてのプログラム\]、\[Microsoft SQL Server 2005\] の順にポイントし、\[SQL Server Management Studio\] をクリックします。

3.  \[サーバーへの接続\] ページで、\[サーバー名\] ボックスに新しいデータベース サーバー名が表示されていることを確認し、\[接続\] をクリックします。

4.  \[データベース\]、\[DRMS\_Config\_*&lt;RMS クラスタ名&gt;***\_***&lt;ポート&gt;*\]、\[テーブル\] を順に展開します。

5.  \[DRMS\_ClusterPolicies\] を右クリックして、\[テーブルを開く\] をクリックします。

6.  結果ウィンドウで、\[LoggingDatabaseServer\] 行の \[PolicyData\] 列の値を新しい RMS データベース サーバー名に変更します。

7.  \[CertificationUserKeyStorageConnectionString\] 行の \[PolicyData\] 列の値を新しいデータベース サーバーに合わせて変更します。値は、「data source=*&lt;新しいデータベース サーバー名*&gt;;integrated」にする必要があります。*&lt;新しいデータベース サーバー名&gt;* は、新しいデータベース サーバーの名前です。

8.  \[DirectoryServicesCacheDatabase\] 行の \[PolicyData\] 列の値に対しても手順 6 ～ 7 を繰り返します。

9.  \[オブジェクト エクスプローラ\] ウィンドウで、\[DRMS\_PluginProperties\] を右クリックし、\[テーブルを開く\] をクリックします。

10. プロパティ ID 101 の \[PERSISTENT\_STORAGE\] で、\[PropertyValue\] 列を新しいデータベース サーバーに合わせて変更します。値は、「data source=*&lt;新しいデータベース サーバー名*&gt;;integrated」にする必要があります。*&lt;新しいデータベース サーバー名&gt;* は、新しいデータベース サーバーの名前です。

11. Microsoft SQL Server Management Studio を閉じます。

RMS クラスタの各サーバーが新しいデータベース サーバー名を使用するように構成する
-------------------------------------------------------------------------------

RMS クラスタの各サーバーが新しいデータベース サーバー名を使用するように構成するには、web.config ファイルを更新し、3 つのレジストリ エントリを更新する必要があります。この作業の完了後、変更を有効にするためインターネット インフォメーション サービス (IIS) を再起動する必要があります。

RMS クラスタの各サーバーの web.config ファイルを更新するには、次の手順に従います。

**RMS クラスタの各サーバーの web.config ファイルを更新するには**
1.  ローカル Administrators グループのメンバとして、RMS クラスタにログオンします。

2.  %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\admin に移動します。

3.  web.config をダブルクリックし、\[一覧からプログラムを選択する\] をクリックして、\[OK\] をクリックします。

4.  \[メモ帳\] をクリックし、\[この種類のファイルを開くときは、選択したプログラムをいつも使う\] チェック ボックスをオフにして、\[OK\] をクリックします。

5.  \[編集\] メニューの \[置換\] をクリックします。

6.  \[検索する文字列\] ボックスに、現在 RMS データベースをホストしている、使用停止にするデータベース サーバーの名前を入力します。

7.  \[置換後の文字列\] ボックスに、RMS データベースをホストする新しいデータベース サーバーの名前を入力します。

8.  \[すべて置換\] をクリックしてから \[キャンセル\] をクリックします。

9.  \[ファイル\] メニューの \[上書き保存\] をクリックします。

10. メモ帳を閉じます。

11. %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\certification ディレクトリと %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\licensing ディレクトリの web.config ファイルに対しても手順 2 ～ 9 を繰り返します。

12. RMS クラスタの各サーバーで手順 1 ～ 11 を繰り返します。

RMS クラスタの各サーバーで新しいデータベース サーバー名に合わせてレジストリを更新する

> [!NOTE]
> レジストリを正しく編集しないと、システムが正常に動作しなくなる場合があります。 レジストリを変更する前に、コンピュータ上の重要なデータのバックアップを作成する必要があります。 

**RMS クラスタの各サーバーのレジストリを更新するには**
1.  ローカル Administrators グループのメンバとして、RMS クラスタにログオンします。

2.  \[スタート\] ボタン、\[ファイル名を指定して実行\] の順にクリックします。

3.  「**regedit.exe**」と入力して \[OK\] をクリックします。

4.  **HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\DRMS\\1.0\\KeyProtection** に移動します。

5.  PASSWORDDERIVEDKEY\_*&lt;古いデータベース サーバー名&gt;*\_DRMS\_CONFIG\_*&lt;RMS クラスタ名&gt;*\_*&lt;ポート&gt;* という名前のレジストリ エントリを次のように変更します。

    PASSWORDDERIVEDKEY\_*&lt;古いデータベース サーバー名&gt;*\_DRMS\_CONFIG\_*&lt;RMS クラスタ名&gt;*\_*&lt;ポート&gt;*

    パラメータの意味は次のとおりです。

    -   *&lt;古いデータベース サーバー名&gt;* は、古いデータベース サーバーの名前です。
    -   *&lt;RMS クラスタ名&gt;* は、RMS クラスタの名前です。
    -   *&lt;ポート&gt;* は、RMS 通信に使用する TCP ポートです。
    -   *&lt;新しいデータベース サーバー名&gt;* は、新しいデータベース サーバーの名前です。

6.  **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet001\\Services\\DRMS\_Logging\_&lt;RMS クラスタ名&gt;\_&lt;ポート&gt;\\Params** に移動します。

7.  データ ソース値が新しいデータベース サーバー名と一致するように ConnectionString レジストリ エントリを変更します。

8.  **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\DRMS\_Logging\_&lt;RMS クラスタ名&gt;\_&lt;ポート&gt;\\Params** に対しても手順 6 ～ 7 を繰り返します。

9.  コマンド プロンプトで「**IISRESET**」と入力し、Enter キーを押します。

10. RMS クラスタのすべてのサーバーで手順 1 ～ 9 を繰り返します。
